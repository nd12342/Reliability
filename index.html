
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reliability Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: linear-gradient(to right, #003366, #0055aa);
      color: white;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    main {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h2 {
      color: #003366;
      margin-bottom: 10px;
    }
    section {
      background-color: white;
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease-in-out;
    }
    section:hover {
      transform: translateY(-4px);
    }
    input[type="file"], input[type="number"] {
      display: block;
      margin: 10px 0 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
    }
    button {
      background-color: #0055aa;
      color: white;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0077cc;
    }
    .result {
      white-space: pre-wrap;
      background: #eef4fb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid #0055aa;
    }
    p {
      margin-top: 0;
      font-size: 15px;
      color: #555;
    }
    .file-desc {
      font-style: italic;
      color: #777;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Reliability Dashboard</h1>
  </header>
  <main>
    <section>
      <h2>Availability</h2>
      <p class="file-desc">ðŸ“„ Upload Mean Time to Repair Analysis and Downtime CSV file. Enter Uptime hours.</p>
      <input type="file" id="mttrFile" />
      <input type="file" id="downtimeFile" />
      <input type="number" id="uptimeHours" placeholder="Enter uptime hours" />
      <button onclick="calculateAvailability()">Calculate Availability</button>
      <div id="availabilityResult" class="result"></div>
    </section>

    <section>
      <h2>Backlog</h2>
      <p class="file-desc">ðŸ“„ Upload Actual vs Estimated Cost and Hours CSV File</p>
      <input type="file" id="backlogFile" />
      <button onclick="calculateBacklog()">Calculate Backlog</button>
      <div id="backlogResult" class="result"></div>
    </section>

    <section>
      <h2>Work Order Compliance</h2>
      <p class="file-desc">ðŸ“„ Upload Completed OnTime/Late Summary CSV File</p>
      <input type="file" id="complianceFile" />
      <button onclick="calculateCompliance()">Calculate Compliance</button>
      <div id="complianceResult" class="result"></div>
    </section>
  </main>

  <script>
    const targetMachines = ['TLC', 'C285a', 'C285b'];

    function parseTimeString(timeStr) {
      const pattern = /(\d+) day\(s\) (\d+) hr\(s\) ([\d.]+) minute\(s\)/;
      const match = pattern.exec(timeStr);
      if (match) {
        return {
          days: parseFloat(match[1]),
          hours: parseFloat(match[2]),
          minutes: parseFloat(match[3])
        };
      }
      return { days: 0, hours: 0, minutes: 0 };
    }

    async function calculateAvailability() {
      const mttrFile = document.getElementById('mttrFile').files[0];
      const downtimeFile = document.getElementById('downtimeFile').files[0];
      const uptimeHours = parseFloat(document.getElementById('uptimeHours').value);

      if (!mttrFile || !downtimeFile || isNaN(uptimeHours)) {
        alert("Please upload both files and enter uptime hours.");
        return;
      }

      const mttrData = await readExcelFile(mttrFile);
      let totalMinutes = 0;
      let workOrders = 0;

      mttrData.forEach(sheet => {
        sheet.forEach(row => {
          const asset = String(row[0] || "");
          if (targetMachines.some(machine => asset.includes(machine))) {
            const timeStr = row[5];
            if (timeStr) {
              const { days, hours, minutes } = parseTimeString(timeStr);
              totalMinutes += (days * 24 * 60) + (hours * 60) + minutes;
              workOrders++;
            }
          }
        });
      });

      let downtimeHours = 0;
      const downtimeData = await readExcelFile(downtimeFile);
      downtimeData.forEach(sheet => {
        sheet.forEach(row => {
          const asset = String(row[0] || "");
          if (targetMachines.some(machine => asset.includes(machine))) {
            const hours = parseFloat(row["Asc WO Hours"] || 0);
            if (!isNaN(hours)) {
              downtimeHours += hours;
            }
          }
        });
      });

      const totalHours = totalMinutes / 60;
      const MTTR = workOrders ? totalHours / workOrders : 0;
      const MTBF = workOrders ? uptimeHours / workOrders : 0;
      const availability = (MTBF + MTTR) ? (MTBF / (MTBF + MTTR)) * 100 : 0;

      document.getElementById('availabilityResult').textContent =
        `--- MTTR / MTBF / Availability ---\n` +
        `Machines: ${targetMachines.join(", ")}\n` +
        `Total MTTR Hours: ${totalHours.toFixed(2)}\n` +
        `Total Downtime Hours: ${downtimeHours.toFixed(2)}\n` +
        `Total Work Orders: ${workOrders}\n` +
        `Uptime: ${uptimeHours} hrs\n` +
        `MTTR: ${MTTR.toFixed(2)} hrs\n` +
        `MTBF: ${MTBF.toFixed(2)} hrs\n` +
        `Availability: ${availability.toFixed(2)} %`;
    }

    async function calculateBacklog() {
      const backlogFile = document.getElementById('backlogFile').files[0];
      if (!backlogFile) {
        alert("Please upload the backlog file.");
        return;
      }

      const data = await readExcelFile(backlogFile);
      let result = "";

      for (const sheet of data) {
        for (let row of sheet) {
          const rowString = row.map(v => String(v)).join(",");
          if (rowString.toLowerCase().includes("totals:")) {
            const index = row.findIndex(v => String(v).toLowerCase().includes("totals:"));
            let actual = parseFloat(row[index + 1]);
            let estimated = parseFloat(row[index + 2]);
            if (!isNaN(actual) && !isNaN(estimated)) {
              const backlog = (estimated / actual) * 100;
              result = `--- Backlog Calculation ---\nActual Hours: ${actual}\nEstimated Hours: ${estimated}\nBacklog: ${backlog.toFixed(2)}%`;
              break;
            }
          }
        }
      }

      document.getElementById('backlogResult').textContent = result || "Could not find backlog data.";
    }

    async function calculateCompliance() {
      const complianceFile = document.getElementById('complianceFile').files[0];
      if (!complianceFile) {
        alert("Please upload the compliance file.");
        return;
      }

      const data = await readExcelFile(complianceFile);
      const headers = {
        "Total PM": null,
        "On-Time PM": null,
        "Late PM": null,
        "Total Non-PM": null,
        "On-Time Non-PM": null,
        "Late Non-PM": null
      };

      for (let sheet of data) {
        let headerRow;
        for (let row of sheet) {
          row.forEach((val, idx) => {
            if (headers.hasOwnProperty(val)) headers[val] = idx;
          });
          if (Object.values(headers).every(v => v !== null)) {
            headerRow = sheet[sheet.indexOf(row) + 2];
            break;
          }
        }

        if (headerRow) {
          const totalPM = parseFloat(headerRow[headers["Total PM"]]) || 0;
          const onTimePM = parseFloat(headerRow[headers["On-Time PM"]]) || 0;
          const totalNonPM = parseFloat(headerRow[headers["Total Non-PM"]]) || 0;
          const onTimeNonPM = parseFloat(headerRow[headers["On-Time Non-PM"]]) || 0;

          const pmPercent = totalPM ? (onTimePM / totalPM) * 100 : 0;
          const nonPmPercent = totalNonPM ? (onTimeNonPM / totalNonPM) * 100 : 0;

          document.getElementById('complianceResult').textContent =
            `--- Work Order Compliance ---\n` +
            `Total PM: ${totalPM}, On-Time PM: ${onTimePM} => ${pmPercent.toFixed(2)}%\n` +
            `Total Non-PM: ${totalNonPM}, On-Time Non-PM: ${onTimeNonPM} => ${nonPmPercent.toFixed(2)}%`;
          return;
        }
      }

      document.getElementById('complianceResult').textContent = "Could not find required compliance headers.";
    }

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const result = Object.keys(workbook.Sheets).map(name =>
            XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1 })
          );
          resolve(result);
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }
  </script>
</body>
</html>
